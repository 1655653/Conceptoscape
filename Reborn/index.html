<html>
<head>
    <title>Open json file</title>
    <script src='jquery-3.3.1.js'></script>
</head>

<body>
    <div id="demo">
    <form id="jsonFile" name="jsonFile" enctype="multipart/form-data" method="post">
       <fieldset>
        <h2>Json File</h2>
            <input type='file' id='fileinput'>
            <input type='button' id='btnLoad' value='Load' onclick='loadFile();'>
        </fieldset>
    </form>
    </div>
    
    <script type="text/javascript">
        //scelta del file json da leggere
        function loadFile() {
            var input, file, fr;
        
            if (typeof window.FileReader !== 'function') {
                alert("The file API isn't supported on this browser yet.");
                return;
            }
        
            input = document.getElementById('fileinput');
            if (!input) {
                alert("Um, couldn't find the fileinput element.");
            }
            else if (!input.files) {
                alert("This browser doesn't seem to support the `files` property of file inputs.");
            }
            else if (!input.files[0]) {
                alert("Please select a file before clicking 'Load'");
            }
            else {
                file = input.files[0];
                fr = new FileReader();
                fr.onload = receivedText;
                fr.readAsText(file);
            }
        
            function receivedText(e) {
                let lines = e.target.result;
                var cont = JSON.parse(lines); 
                ontologyParse(cont);

                // document.getElementById("demo").innerHTML = cont.Optional_Roles;
            }
        
        }
    //trova la stringa con il nome dell'operazione
    function findOperation(element){
        if(element.slice(0,4) != "http"){
            var end = element.indexOf("(");
            return element.substr(0,end);
        }
        else return null;
    }

    function getPrefix(element){
        return element.slice(element.indexOf("www.")+4,element.indexOf(".it"));
    }

    function getBody(element){
        return element.slice(element.indexOf("#")+1,element.length);
    }
    
    //--------------------------parser dell'ontologia
    function ontologyParse(cont){
        
        if(cont.Sub_Concepts != undefined){ //nel json Ã¨ presente la voce sub_concepts
            for (let index = 0; index < cont.Sub_Concepts.length; index++) {
                const element = cont.Sub_Concepts[index];
                parseRecursive(element);
            }//FINE for
        } //FINE Sub_Concepts
        
    
        if(cont.Super_Concepts != undefined){ 
            for (let index = 0; index < cont.Super_Concepts.length; index++) {
                const element = cont.Super_Concepts[index];
                //posto che non ci siano altre cose tipo objectUnionOf
                if((checkPrefix(element))){
                    var body = getBody(element);
                    body = getPrefix(element)+":"+body;
                    //ADESSO BODY LO DO IN PASTO A CYTOSCAPE COME SINGOLO ELEMENTO//-----------DA IMPLEMENTARE
                }
                else {
                    //RILANCIA ERRORE MAPPA PREFISSI //-----------DA IMPLEMENTARE
                }
                
            }
        }//FINE Super_Concepts

        if(cont.Optional_Attributes != undefined){
            for (let index = 0; index < cont.Optional_Attributes.length; index++) {
                const element = cont.Optional_Attributes[index];
                //posto che non ci siano altre cose tipo objectUnionOf
                if((checkPrefix(element))){
                    var body = getBody(element);
                    body = getPrefix(element)+":"+body;
                    //ADESSO BODY LO DO IN PASTO A CYTOSCAPE COME SINGOLO ELEMENTO//-----------DA IMPLEMENTARE
                }
                else {
                    //RILANCIA ERRORE MAPPA PREFISSI //-----------DA IMPLEMENTARE
                }
                
            }
        }//FINE Optional_Attributes

        if(cont.Mandatory_Attributes != undefined){
            for (let index = 0; index < cont.Mandatory_Attributes.length; index++) {
                const element = cont.Mandatory_Attributes[index];
                //posto che non ci siano altre cose tipo objectUnionOf
                if((checkPrefix(element))){
                    var body = getBody(element);
                    body = getPrefix(element)+":"+body;
                    //ADESSO BODY LO DO IN PASTO A CYTOSCAPE COME SINGOLO ELEMENTO//-----------DA IMPLEMENTARE
                }
                else {
                    //RILANCIA ERRORE MAPPA PREFISSI //-----------DA IMPLEMENTARE
                }
                
            }
        }//FINE Mandatory_Attributes

        if(cont.Mandatory_Roles != undefined){
            for (let index = 0; index < cont.Mandatory_Roles.length; index++) {
                const element = cont.Mandatory_Roles[index];
                //posto che non ci siano altre cose tipo objectUnionOf
                if((checkPrefix(element))){
                    var body = getBody(element);
                    body = getPrefix(element)+":"+body;
                    //ADESSO BODY LO DO IN PASTO A CYTOSCAPE COME SINGOLO ELEMENTO//-----------DA IMPLEMENTARE
                }
                else {
                    //RILANCIA ERRORE MAPPA PREFISSI //-----------DA IMPLEMENTARE
                }
                
            }
        }//FINE Mandatory_Roles

        if(cont.Optional_Roles != undefined){
            for (let index = 0; index < cont.Optional_Roles.length; index++) {
                const element = cont.Optional_Roles[index];
                //posto che non ci siano altre cose tipo objectUnionOf
                if((checkPrefix(element))){
                    var body = getBody(element);
                    body = getPrefix(element)+":"+body;
                    //ADESSO BODY LO DO IN PASTO A CYTOSCAPE COME SINGOLO ELEMENTO//-----------DA IMPLEMENTARE
                }
                else {
                    console.log("diocane");
                    //RILANCIA ERRORE MAPPA PREFISSI //-----------DA IMPLEMENTARE
                }
                
            }
        }//FINE Optional_Roles
        function checkPrefix(element){
            var prefix =  getPrefix(element);
            for (let index = 0; index < cont.Prefix_Map.length; index++) {
                const element = cont.Prefix_Map[index];
                if(element == prefix) return true;
                
            }
            return false;
        }
        function parseRecursive(element){ 
            var operation = findOperation(element);
            if(operation == null && checkPrefix(element)){//passo base es[http://www.istat.it/ontology/poc/#Residente]
                var body = getBody(element);
                body = getPrefix(element)+":"+body;
                console.log(body);
                
                //ADESSO BODY LO DO IN PASTO A CYTOSCAPE COME SINGOLO ELEMENTO//-----------DA IMPLEMENTARE
            }
            else{
                var str = element.substring(operation.length+1,element.length-1); //togli parentesi
                var str2;
                if(str.slice(0,4) == "http"){ //es OBJ(a OBJ(c d))
                    str2 = str.substring(str.indexOf(" ")+1,str.length);
                    str = str.substring(0,str.indexOf(" "));
                    parseRecursive(str);
                    parseRecursive(str2);
                }
                else{
                    var i = 0;
                    for (let index = 0; index < str.length; index++) {
                        const elem = str[index];
                        if(elem == "(") i++;
                        if(elem == ")") {
                            i--;
                            if(i == 0){
                                str2 = str.substr(index+2,str.length);
                                str = str.substring(0,index+1);
                                i = 1000;
                            }
                        }
                    }
                    parseRecursive(str);
                    parseRecursive(str2);
                }   
            }
        }
    }
    </script>
        
</body>
</html>
