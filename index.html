<!doctype html>

<html>

<head>
    <meta charset="utf-8"></meta>
    <title>Conceptoscape</title>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.2.18/cytoscape.js"></script>

    <script src="https://cdn.rawgit.com/cytoscape/cytoscape.js-cola/1.6.0/cola.js"></script>
    <script src="https://cdn.rawgit.com/cytoscape/cytoscape.js-qtip/2.7.0/cytoscape-qtip.js"></script>
    <script src="https://cdn.rawgit.com/cytoscape/cytoscape.js-cola/1.6.0/cytoscape-cola.js"></script> -->

    <script src='stile.js'></script>
    <script src='cytoscape.js'></script>

</head>

<style>
    #cy {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0px;
        left: 0px;
    }
</style>

<body>
    <div id="cy"></div>
    
    <script>
        function NodeGenerator( n ){
            for (var i = 0; i < n; i++) {
                cy.add({
                    group:"nodes",
                    data: { id: 'node' + i ,type: 'subConcept'},
                    position: { x: 200*i, y:450 }
                    }
                );
                var source = 'node' + i;
                cy.add({
                    group:"edges",
                    data: {
                        id: 'edge' + i,
                        source: source,
                        target: 'b',
                        type : 'descendant'
                    }
                });
            }
        }
        
        function FakeAttrGen(){
            var d = cy.$("node[type = 'complexAttribute']");
            for (let i = 0; i < d.length; i++) {
                var ix = d[i].position('x');
                var iy = d[i].position('y');
                var iddi = d[i].data('id');
                cy.add([
                    {
                    group:'nodes',
                    data: { id: iddi+'fake', type: 'fakeAttribute'},
                    position:{ x: ix , y: iy}
                    }
                ]);
            }
        }

        
        function SimpleAttrRoleGenerator( src, targt, arrstyle, colorExists,typ){ //crea nodo concetto + exists + archi
            
            
           
            cy.add([
                { group:"nodes",data: { id: src, type: typ }}, //nodo giusto
                { group:"nodes",data: { id: 'exists'+src+targt, type: colorExists }}, //exists

                {   
                    group:"edges",
                    data: { //edge nodo--->exists
                    id: 'edgeExists'+src+targt, 
                    source: src,
                    target: 'exists'+src+targt,
                    type: 'descendant' } 
                },
                { 
                    group:"edges",                    
                    data: { //edge exists--->target
                    id: 'edgetarget'+src+targt, 
                    source: 'exists'+src+targt,
                    target: targt,
                    type: arrstyle } 
                }

            ]);
        }
        
        var cy = cytoscape({
            container: document.getElementById('cy'),
            style: stile
        });
            
        //ARCHI E NODI MESSI A MANO
        
        cy.add([
            {
            group:'nodes',
            data: { id: 'Book', type: 'starConcept'},
            },
            {
            group:'nodes',
            data: { id: 'b', type: 'subOuo'},
            },
            {
            group:'nodes',
            data: { id: 'E-book', type: 'subConcept'},
            },
            {
            group:'nodes',
            data: { id: 'AudioBook', type: 'subConcept'},
            },
            {
            group:'nodes',
            data: { id: 'PrintedBook', type: 'subConcept'},
            },
            {
            group:'edges',
            data: {
                id: 'Bookb',
                source: 'b',
                target: 'Book',
                type:'normal'
            }
            },
            {
            group:'edges',
            data: {
                id: 'bE-book',
                source: 'E-book',
                target: 'b',
                type:'descendant'
            }
            },
            {
            group:'edges',
            data: {
                id: 'bAudioBook',
                source: 'AudioBook',
                target: 'b',
                type:'descendant'
            }
            },
            {
            group:'edges',
            data: {
                id: 'bPrintedBook',
                source: 'PrintedBook',
                target: 'b',
                type:'descendant'
            }
            },
            //nodi esempio-------------------------------------
            {
            group:'nodes',
            data: { id: 'be', type: 'subOuo'},
            },
            {
            group:'edges',
            data: {
                id: 'Bookbe',
                source: 'be',
                target: 'Book',
                type:'normal'
            }
            },
            {
            group:'nodes',
            data: { id: 'Educational', type: 'subConcept'},
            },
            {
            group:'nodes',
            data: { id: 'Tutorial', type: 'subConcept'},
            },
            {
            group:'nodes',
            data: { id: 'Literature', type: 'subConcept'},
            },
            {
            group:'edges',
            data: {
                id: 'beEducational',
                source: 'Educational',
                target: 'be',
                type:'descendant'
            }
            },
            {
            group:'edges',
            data: {
                id: 'beTutorial',
                source: 'Tutorial',
                target: 'be',
                type:'descendant'
            }
            },
            {
            group:'edges',
            data: {
                id: 'beLiterature',
                source: 'Literature',
                target: 'be',
                type:'descendant'
            }
            }
            
        ]);
        
        
        // NodeGenerator(10);
        SimpleAttrRoleGenerator(':title','Book','doublenormal','existsW','complexAttribute');
        SimpleAttrRoleGenerator(':genre','Book','doublenormal','existsW','complexAttribute');
        SimpleAttrRoleGenerator(':writtenBy','Book','doublenormal','existsW','simpleRole');
        
        
        cy.layout({
            name:'preset',

        }).run(); 
        
        var nodes = cy.nodes('node');

        var elenco = {
            attribute: [],
            role: [],
            subOuo: [],
            superOuo: []
        };

        for (let i = 0; i < nodes.length; i++) {
            const node = nodes[i];
            Grapholy( node);
        }

        function Grapholy( node ){
            var star = cy.$id('Book');
            var starx = star.position('x');
            var stary = star.position('y');

            if(node.data('type') == "simpleAttribute" || node.data('type') == "complexAttribute"){
                nodeAttrid = node.data('id');
                var nodeExists = cy.$id('exists'+nodeAttrid+'Book');
                var min = Math.ceil(-35);
                var max = Math.floor(35);
                var n = Math.floor(Math.random() * (max - min + 1)) + min;

                for (let i = 0; i < elenco.attribute.length; i++) {
                    const element = elenco.attribute[i];
                    while(Math.abs(n-element) < 12){
                        n = n+15;
                    }     
                }

                elenco.attribute.push(n);
                
                nodeExists.position({
                    x: starx + 100,
                    y: stary + n 
                });

                node.position({
                    x:nodeExists.position('x')+50,
                    y:nodeExists.position('y')
                })
            }
            
            else if(node.data('type') == "simpleRole" || node.data('type') == "complexRole"){
                nodeRoleid = node.data('id');
                var nodeExists = cy.$id('exists'+nodeRoleid+'Book');
                var min = Math.ceil(-35);
                var max = Math.floor(35);
                var n = Math.floor(Math.random() * (max - min + 1)) + min;

                for (let i = 0; i < elenco.role.length; i++) {
                    const element = elenco.role[i];
                    while(Math.abs(n-element) < 16){
                        n = n+15;
                    }     
                }

                elenco.role.push(n);
                
                nodeExists.position({
                    x: starx - 100,
                    y: stary + n 
                });

                node.position({
                    x:nodeExists.position('x')-80,
                    y:nodeExists.position('y')
                })
            }
            
            else if(node.data('type') == "subOuo" || node.data('type') == "andornot"){
                

                var min = Math.ceil(-180);
                var max = Math.floor(180);
                var n = Math.floor(Math.random() * (max - min + 1)) + min;


                node.position('y',stary + 90);

                if(elenco.subOuo.length == 0){ ///primo nodo ouo
                    node.position('x',starx + n);
                }

                for (let i = 0; i < elenco.subOuo.length; i++) {
                    const element = elenco.subOuo[i];
                    while(n<element){
                        n = n+5;
                    }     
                    node.position('x',n);
                }
                


                subConcetti = node.incomers('node[type = "subConcept"]');
                var ouox = node.position('x');
                var ouoy = node.position('y');
                var range = subConcetti.length * 90 //70*NUM NODI (LUNGH)+ 20*NUM NODI(SPAZIO) 
                var start = ouox - (range/2);
                var stop = ouox + (range/2);

                

                for (let i = 0; i < elenco.subOuo.length; i++) {
                    var element = elenco.subOuo[i];
                    while( start<element ){
                        start = start+5;
                        stop = stop+5;
                    }
                }

                elenco.subOuo.push(stop);
                    
                console.log(start)
                console.log(stop)
                for (let i = 0; i < subConcetti.length; i++) {
                    const nodeSubCon = subConcetti[i];
                    nodeSubCon.position({
                        x: start,
                        y: ouoy + 90
                    });
                    start += 90;
                    
                }

            }
   
        }

        cy.fit(cy.$id("Book"),275);
        
       FakeAttrGen();

            

        var compAtrr = cy.$('node[type = "complexAttribute"]');
        compAtrr.on('grabon drag',function(evt){
            var node = evt.target;
            var idnode = node.data('id');
            var fakenode = cy.$id(idnode+'fake');
            var ix = node.position('x');
            var iy = node.position('y');
            fakenode.position({
                x: ix,
                y: iy
            });
        });

        var fakeAtrr = cy.$('node[type = "fakeAttribute"]');
        fakeAtrr.on('grabon drag',function(evt){
            var node = evt.target;
            var idnode = node.data('id');
            var l = idnode.length;
            idnode = idnode.slice(0,l-4);
            var realnode = cy.$id(idnode);
            var ix = node.position('x');
            var iy = node.position('y');
            realnode.position({
                x: ix,
                y: iy
            });
        });
            
            

            

    </script>
</body>
