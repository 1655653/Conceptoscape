<!doctype html>

<html>

<head>
    <meta charset="utf-8"></meta>
    <title>Conceptoscape</title>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.2.18/cytoscape.js"></script>

    <script src="https://cdn.rawgit.com/cytoscape/cytoscape.js-cola/1.6.0/cola.js"></script>
    <script src="https://cdn.rawgit.com/cytoscape/cytoscape.js-qtip/2.7.0/cytoscape-qtip.js"></script>
    <script src="https://cdn.rawgit.com/cytoscape/cytoscape.js-cola/1.6.0/cytoscape-cola.js"></script> -->

    <script src='stile.js'></script>
    <script src='cytoscape.js'></script>

</head>

<style>
    #cy {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0px;
        left: 0px;
    }
</style>

<body>
    <div id="cy"></div>
    <script>
        //GRAPHOLY SERVE PER CREARE IL LAYOUT IN STILE GRAPHOL
        function Grapholy( node ){
            var star = cy.$id('Book');
            var starx = star.position('x');
            var stary = star.position('y');

            if(node.data('type') == "simpleAttribute" || node.data('type') == "complexAttribute"){
                nodeAttrid = node.data('id');
                var nodeExists = cy.$id('exists'+nodeAttrid+'Book');
                var min = Math.ceil(-35);
                var max = Math.floor(35);
                var n = Math.floor(Math.random() * (max - min + 1)) + min;

                for (let i = 0; i < elenco.attribute.length; i++) {
                    const element = elenco.attribute[i];
                    while(Math.abs(n-element) < 12){
                        n = n+15;
                    }     
                }

                elenco.attribute.push(n);
                
                nodeExists.position({
                    x: starx + 100,
                    y: stary + n 
                });

                node.position({
                    x:nodeExists.position('x')+50,
                    y:nodeExists.position('y')
                })
            }
            
            else if(node.data('type') == "simpleRole" || node.data('type') == "complexRole" || node.data('type') == "doubleComplexRole" ){
                nodeRoleid = node.data('id');
                var nodeExists = cy.$id('exists'+nodeRoleid+'Book');
                var min = Math.ceil(-35);
                var max = Math.floor(35);
                var n = Math.floor(Math.random() * (max - min + 1)) + min;

                for (let i = 0; i < elenco.role.length; i++) {
                    const element = elenco.role[i];
                    while(Math.abs(n-element) < 16){
                        n = n+15;
                    }     
                }

                elenco.role.push(n);
                
                nodeExists.position({
                    x: starx - 100,
                    y: stary + n 
                });

                node.position({
                    x:nodeExists.position('x')-80,
                    y:nodeExists.position('y')
                })
            }
            
            else if(node.data('type') == "subOuo" || node.data('type') == "subAndornot"){
                

                var min = Math.ceil(-180);
                var max = Math.floor(180);
                var n = Math.floor(Math.random() * (max - min + 1)) + min;


                node.position('y',stary + 90);

                if(elenco.subOuo.length == 0){ ///primo nodo ouo
                    node.position('x',starx + n);
                }

                for (let i = 0; i < elenco.subOuo.length; i++) {
                    const element = elenco.subOuo[i];
                    while(n<element){
                        n = n+5;
                    }     
                    node.position('x',n);
                }
                


                var subConcetti = node.incomers('node[type = "subConcept"]');
                var ouox = node.position('x');
                var ouoy = node.position('y');
                var range = subConcetti.length * 90 //70*NUM NODI (LUNGH)+ 20*NUM NODI(SPAZIO) 
                var start = ouox - (range/2);
                var stop = ouox + (range/2);

                

                for (let i = 0; i < elenco.subOuo.length; i++) {
                    var element = elenco.subOuo[i];
                    while( start<element ){
                        start = start+5;
                        stop = stop+5;
                    }
                }

                elenco.subOuo.push(stop);
                    
                for (let i = 0; i < subConcetti.length; i++) {
                    const nodeSubCon = subConcetti[i];
                    nodeSubCon.position({
                        x: start,
                        y: ouoy + 90
                    });
                    start += 90;
                    
                }

            }
            
            else if(node.data('type') == "superOuo" || node.data('type') == "superAndornot"){
                var min = Math.ceil(-180);
                var max = Math.floor(180);
                var n = Math.floor(Math.random() * (max - min + 1)) + min;


                node.position('y',stary - 90);

                if(elenco.superOuo.length == 0){ ///primo nodo ouo
                    node.position('x',starx + n);
                }

                for (let i = 0; i < elenco.superOuo.length; i++) {
                    const element = elenco.superOuo[i];
                    while(n<element){
                        n = n+5;
                    }     
                    node.position('x',n);
                }
                


                var superConcetti = node.incomers('node[type = "superConcept"]');
                var ouox = node.position('x');
                var ouoy = node.position('y');
                var range = superConcetti.length * 90 //70*NUM NODI (LUNGH)+ 20*NUM NODI(SPAZIO) 
                var start = ouox - (range/2);
                var stop = ouox + (range/2);

                

                for (let i = 0; i < elenco.superOuo.length; i++) {
                    var element = elenco.superOuo[i];
                    while( start<element ){
                        start = start+5;
                        stop = stop+5;
                    }
                }

                elenco.superOuo.push(stop);
                    
                
                for (let i = 0; i < superConcetti.length; i++) {
                    const nodeSupCon = superConcetti[i];
                    nodeSupCon.position({
                        x: start,
                        y: ouoy - 90
                    });
                    start += 90;
                    
                }

            }
        }

        //GESTORE DEI NODI FAKE, LAYOUT
        function FakeManager(){
            var compAtrr = cy.$('node[type = "complexAttribute"],[type = "doubleComplexRole"]');
            compAtrr.on('grabon drag',function(evt){
                var node = evt.target;
                var idnode = node.data('id');
                var fakenode = cy.$id(idnode+'fake');
                var ix = node.position('x');
                var iy = node.position('y');
                fakenode.position({
                    x: ix,
                    y: iy
                });
            });

            var fakeAtrr = cy.$('node[type = "fakeAttribute"],[type = "fakeRole"]');
            fakeAtrr.on('grabon drag',function(evt){
                var node = evt.target;
                var idnode = node.data('id');
                var l = idnode.length;
                idnode = idnode.slice(0,l-4);
                var realnode = cy.$id(idnode);
                var ix = node.position('x');
                var iy = node.position('y');
                realnode.position({
                    x: ix,
                    y: iy
                });
            });

            var sfr = cy.$('node[type = "simpleFakeRole"]');
            sfr.on('grabon drag',function(evt){
                var node = evt.target;
                var idnode = node.data('id');
                var l = idnode.length;
                idnode = idnode.slice(4);
                var realnode = cy.$id(idnode);
                var ix = node.position('x');
                var iy = node.position('y');
                realnode.position({
                    x: ix,
                    y: iy
                });
                var fakeRole = cy.$id(idnode+"fake");
                fakeRole.position({
                    x: ix,
                    y: iy
                });
            });
        }

        //GENERATORE DEI NODI ATTRIBUTO FAKE
        function FakeAttrGen(){
            var d = cy.$("node[type = 'complexAttribute']");
            for (let i = 0; i < d.length; i++) {
                var ix = d[i].position('x');
                var iy = d[i].position('y');
                var iddi = d[i].data('id');
                cy.add([
                    {
                    group:'nodes',
                    data: { id: iddi+'fake', type: 'fakeAttribute'},
                    position:{ x: ix , y: iy}
                    }
                ]);
            }
        }

        //GENERATORE DEI NODI RUOLO FAKE
        function FakeRoleGen(){
            var d = cy.$("node[type = 'doubleComplexRole']");
            for (let i = 0; i < d.length; i++) {
                var ix = d[i].position('x');
                var iy = d[i].position('y');
                var iddi = d[i].data('id');
                cy.add([
                    {
                    group:'nodes',
                    data: { id: iddi+'fake', type: 'fakeRole'},
                    position:{ x: ix , y: iy}
                    },
                    {
                    group:'nodes',
                    data: { id: 'fake'+iddi, type: 'simpleFakeRole'},
                    position:{ x: ix , y: iy},
                    }
                ]);
            }

        }
        
        //GENERATORE DI SUPER E SUB CONCETTI
        function SubSuperConceptGenerator(src, ouoStarArr, typeConcept, typeOuo, ouoConceptArr, aonName){ //src è una str dati
            //ouoStarArr--> tipo arco che va da ouo a star
            //typeConcept--> tipo dei concetti figli (sub o super)
            //typeouo--> tipo degli (sub o super / andornot o ouo)
            //ouoStarArr--> tipo arco che va da ouo a star
            //aonName--> node che deve apparire nel ouo solo nel caso in cui è andornot
            if(typeOuo == "superAndornot" || typeOuo == "subAndornot"){
                cy.add([
                    {group: 'nodes', data: { id: 'ouo'+src[0], type: typeOuo, andornot: aonName}},
                    {
                        group: 'edges', 
                        data:{
                            id: 'ouo'+'Book'+src[0],
                            source: 'ouo'+src[0],
                            target: 'Book',
                            type:ouoStarArr
                        }
                    }
                ]);
            }
            else{
                cy.add([
                    {group: 'nodes', data: { id: 'ouo'+src[0], type: typeOuo}},
                    {
                        group: 'edges', 
                        data:{
                            id: 'ouo'+'Book'+src[0],
                            source: 'ouo'+src[0],
                            target: 'Book',
                            type:ouoStarArr
                        }
                    }
                ]);
            }
                
            for (let i = 0; i < src.length; i++) {
                const el = src[i];
                cy.add([
                    {group: 'nodes', data: { id: el, type: typeConcept}}, //nodo concetto per ogni src
                    {
                        group: 'edges', 
                        data:{
                            id: 'ouo'+src[0]+el,
                            source: el,
                            target: 'ouo'+src[0],
                            type:ouoConceptArr
                        }
                    }
                ]);
            }
            
        }
        

        //GENERATORE DI RUOLI E ATTRIBUTI 
        function AttrRoleGenerator( src, targt, arrstyle, colorExists,typ){ //crea nodo concetto + exists + archi
            cy.add([
                { group:"nodes",data: { id: src, type: typ }}, //creo nodo giusto
                { group:"nodes",data: { id: 'exists'+src+targt, type: colorExists }}, //creo nodo exists

                {   
                    group:"edges",
                    data: { // creo edge nodo--->exists
                    id: 'edgeExists'+src+targt, 
                    source: src,
                    target: 'exists'+src+targt,
                    type: 'descendant' } 
                },
                { 
                    group:"edges",                    
                    data: { //creo edge exists--->target
                    id: 'edgetarget'+src+targt, 
                    source: 'exists'+src+targt,
                    target: targt,
                    type: arrstyle } 
                }

            ]);
        }
        
        //CREAZIONE DELL ELEMENTO CY 
        var cy = cytoscape({
            container: document.getElementById('cy'),
            style: stile
        });

        //CREAZIONE NODO STAR
        cy.add([
            {
                group:'nodes',
                data: { id: 'Book', type: 'starConcept'},
            }
        ]);

        //INIZIO MAIN
            //creazione di ruoli e attributi e concetti
        var src1 = ['PrintedBook','E-book','AudioBook'];
        var src2 = ['Literature','Tutorial','Educational'];
        SubSuperConceptGenerator(src1, 'normal', 'subConcept', 'subOuo', 'descendant');
        SubSuperConceptGenerator(src2, 'normal', 'subConcept', 'subOuo', 'descendant');

        AttrRoleGenerator(':title','Book','doublenormal','existsW','complexAttribute');
        AttrRoleGenerator(':genre','Book','doublenormal','existsW','complexAttribute');
        AttrRoleGenerator(':writtenBy','Book','doublenormal','existsW','simpleRole');
        // NodeGenerator(10);
           
        //FINE MAIN
        
        //INIZIO GESTIONE DEL LAYOUT
        
        cy.layout({
            name:'preset',

        }).run(); 
        
        var nodes = cy.nodes('node');

        var elenco = {
            attribute: [],
            role: [],       //strutt.dati per le coordinate
            subOuo: [],
            superOuo: []
        };

        for (let i = 0; i < nodes.length; i++) {
            const node = nodes[i];
            Grapholy( node);
        }

        cy.fit(cy.$id("Book"),275);
        //FINE GESTIONE LAYOUT
        
        //INIZIO GESTIONE NODI FAKE 

        FakeAttrGen();
        FakeRoleGen();
        FakeManager();

        //FINE GESTIONE NODI FAKE

            
            

            

    </script>
    
</body>
